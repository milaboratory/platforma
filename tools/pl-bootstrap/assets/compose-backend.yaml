name: "platforma"

services:
  minio:
    image: ${MINIO_IMAGE}
    command: server /data --address "0.0.0.0:9000" --console-address "0.0.0.0:9001"

    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    
    environment:
      MINIO_ROOT_USER: testuser
      MINIO_ROOT_PASSWORD: testpassword

    volumes:
      - "${MINIO_STORAGE}:/data"

  backend:
    image: ${PL_IMAGE}
    ports:
      - "${PL_LISTEN_ADDRESS:-127.0.0.1}:${PL_LISTEN_PORT:-6345}:6345"
      - "${PL_LISTEN_ADDRESS:-127.0.0.1}:${PL_LISTEN_HTTP_PORT:-6347}:6347"
      - "${PL_MONITORING_IP:-127.0.0.1}:${PL_MONITORING_PORT:-9090}:9090"
      - "${PL_DEBUG_IP:-127.0.0.1}:${PL_DEBUG_PORT:-9091}:9091"
    tmpfs: [ /tmp ]

    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "4"

    environment:
      # Make docker container to write final configuration to stdout at start
      - "PL_DUMP_CONFIG_BEFORE_RUN=true"

      # License settings
      - "PL_LICENSE=${PL_LICENSE:-}"
      - "PL_LICENSE_FILE=${PL_LICENSE_FILE:+/storage/mi.license}"

      # Main storage configuration
      - "PL_MAIN_ROOT=/storage"
      - "PL_DB_DIR=/storage/rocksdb"
      - "PL_WORK_DIR=/storage/work"
      - "PL_PACKAGES_DIR=/storage/packages"

      # Listen configuration
      - "PL_LISTEN_ADDRESS=0.0.0.0"
      - "PL_LISTEN_PORT=6345"
      - "PL_LISTEN_HTTP_PORT=6347"
      # - "PL_LISTEN_TLS=${PL_LISTEN_TLS:-}"
      # - "PL_LISTEN_TLS_ORG=${PL_LISTEN_TLS_ORG:-}" # Platforma
      # - "PL_LISTEN_TLS_DOMAINS=${PL_LISTEN_TLS_DOMAINS:-}"
      # - "PL_LISTEN_TLS_IPS=${PL_LISTEN_TLS_IPS:-}"

      # Monitoring configuration
      - "PL_NO_MONITORING=${PL_NO_MONITORING:-false}"
      - "PL_MONITORING_PORT=9090"
      - "PL_MONITORING_IP=0.0.0.0"
      - "PL_NO_MONITORING_DUMPS=${PL_NO_MONITORING_DUMPS:-false}"
      - "PL_MONITORING_DUMP_DIR=/storage/metrics"
      - "PL_MONITORING_DUMP_RETENTION=${PL_MONITORING_DUMP_RETENTION:-48h}"
      - "PL_MONITORING_DUMP_INTERVAL=${PL_MONITORING_DUMP_INTERVAL:-20s}"

      # Debug configuration
      - "PL_DEBUG_ENABLED=${PL_DEBUG_ENABLED:-true}"
      - "PL_DEBUG_PORT=9091"
      - "PL_DEBUG_IP=0.0.0.0"

      # Logging configuration
      - "PL_LOG_DESTINATION=${PL_LOG_DIR:+dir://${PL_LOG_DIR}}"

      - "PL_LOG_LEVEL=${PL_LOG_LEVEL:-warn}"
      - "PL_LOG_ROTATION_SIZE=${PL_LOG_ROTATION_SIZE:-20MiB}"
      - "PL_LOG_ROTATION_BACKUPS=${PL_LOG_ROTATION_BACKUPS:-20}"
      - "PL_NO_LOG_ROTATION=${PL_NO_LOG_ROTATION:-false}"
      - "PL_NO_LOG_COMPRESSION=${PL_NO_LOG_COMPRESSION:-false}"
      - "PL_LOG_EXTENDED=${PL_LOG_EXTENDED:-false}"

      # Authentication configuration
      - "PL_NO_AUTH=${PL_NO_AUTH:-false}"
      - "PL_AUTH_HTPASSWD=${PL_AUTH_HTPASSWD:+/etc/platforma/users.htpasswd}"
      # - "PL_AUTH_LDAP_SERVER=${PL_AUTH_LDAP_SERVER:-}"
      # - "PL_AUTH_LDAP_DN=${PL_AUTH_LDAP_DN:-}"
      - "PL_AUTH_LDAP_START_TLS=${PL_AUTH_LDAP_START_TLS:-false}"
      # - "PL_AUTH_LDAP_TLS=${PL_AUTH_LDAP_TLS:-}"
      # - "PL_AUTH_LDAP_CLIENT_CAS=${PL_AUTH_LDAP_CLIENT_CAS:-}"
      # - "PL_AUTH_LDAP_ROOT_CAS=${PL_AUTH_LDAP_ROOT_CAS:-}"

      # Primary storage configuration
      - "PL_PRIMARY_STORAGE_S3=${PL_PRIMARY_STORAGE_S3:-http://minio:9000/platforma-primary-bucket}"
      - "PL_PRIMARY_STORAGE_S3_REGION=${PL_PRIMARY_STORAGE_S3_REGION:-eu-central-1}"
      - "PL_PRIMARY_STORAGE_S3_KEY=${PL_PRIMARY_STORAGE_S3_KEY:-testuser}"
      - "PL_PRIMARY_STORAGE_S3_SECRET=${PL_PRIMARY_STORAGE_S3_SECRET:-testpassword}"
      - "PL_PRIMARY_STORAGE_S3_EXTERNAL_ENDPOINT=${PL_PRIMARY_STORAGE_S3_EXTERNAL_ENDPOINT:-http://localhost:9000}"
      - "PL_PRIMARY_STORAGE_S3_NO_DATA_INTEGRITY=${PL_PRIMARY_STORAGE_S3_NO_DATA_INTEGRITY:-false}"
      # - "PL_PRIMARY_STORAGE_GCS=${PL_PRIMARY_STORAGE_GCS:-}"
      # - "PL_PRIMARY_STORAGE_GCS_PROJECT_ID=${PL_PRIMARY_STORAGE_GCS_PROJECT_ID:-}"
      # - "PL_PRIMARY_STORAGE_GCS_SERVICE_ACCOUNT=${PL_PRIMARY_STORAGE_GCS_SERVICE_ACCOUNT:-}"
      # - "PL_PRIMARY_STORAGE_GCS_JSON_FILE_PATH=${PL_PRIMARY_STORAGE_GCS_JSON_FILE_PATH:-}"
      # - "PL_PRIMARY_STORAGE_FS=${PL_PRIMARY_STORAGE_FS:-}"
      # - "PL_PRIMARY_STORAGE_FS_URL=${PL_PRIMARY_STORAGE_FS_URL:-}"

      # Data library configuration
      - "PL_NO_HOST_DATA_LIBRARY=${PL_NO_HOST_DATA_LIBRARY:-false}"
      - "PL_DATA_LIBRARY_FS_PATH=host=/storage/library"
      # S3 data library - only set if explicitly provided
      # - "PL_DATA_LIBRARY_S3_URL=${PL_DATA_LIBRARY_S3_URL:-}"
      # - "PL_DATA_LIBRARY_S3_REGION=${PL_DATA_LIBRARY_S3_REGION:-}"
      # - "PL_DATA_LIBRARY_S3_KEY=${PL_DATA_LIBRARY_S3_KEY:-}"
      # - "PL_DATA_LIBRARY_S3_SECRET=${PL_DATA_LIBRARY_S3_SECRET:-}"
      # - "PL_DATA_LIBRARY_S3_EXTERNAL_ENDPOINT=${PL_DATA_LIBRARY_S3_EXTERNAL_ENDPOINT:-}"
      # - "PL_DATA_LIBRARY_S3_NO_DATA_INTEGRITY=${PL_DATA_LIBRARY_S3_NO_DATA_INTEGRITY:-false}"
      # GCS data library - only set if explicitly provided
      # - "PL_DATA_LIBRARY_GCS_URL=${PL_DATA_LIBRARY_GCS_URL:-}"
      # - "PL_DATA_LIBRARY_GCS_PROJECT_ID=${PL_DATA_LIBRARY_GCS_PROJECT_ID:-}"
      # - "PL_DATA_LIBRARY_GCS_SERVICE_ACCOUNT=${PL_DATA_LIBRARY_GCS_SERVICE_ACCOUNT:-}"
      # - "PL_DATA_LIBRARY_GCS_JSON_FILE_PATH=${PL_DATA_LIBRARY_GCS_JSON_FILE_PATH:-}"

      # Runner configuration
      - "PL_RUNNER_LOCAL_CPU=${PL_RUNNER_LOCAL_CPU:-1}"
      - "PL_RUNNER_LOCAL_RAM=${PL_RUNNER_LOCAL_RAM:-95%}"
      # - "PL_RUNNER_GOOGLE_BATCH_SHARED_STORAGE=${PL_RUNNER_GOOGLE_BATCH_SHARED_STORAGE:-}"
      # - "PL_RUNNER_GOOGLE_BATCH_PROJECT=${PL_RUNNER_GOOGLE_BATCH_PROJECT:-}"
      # - "PL_RUNNER_GOOGLE_BATCH_REGION=${PL_RUNNER_GOOGLE_BATCH_REGION:-}"
      - "PL_RUNNER_GOOGLE_BATCH_JOB_NAME_PREFIX=${PL_RUNNER_GOOGLE_BATCH_JOB_NAME_PREFIX:-pl-cmd}"
      # - "PL_RUNNER_GOOGLE_BATCH_JOB_IMAGE=${PL_RUNNER_GOOGLE_BATCH_JOB_IMAGE:-}"
      # - "PL_RUNNER_GOOGLE_BATCH_NETWORK=${PL_RUNNER_GOOGLE_BATCH_NETWORK:-}"
      # - "PL_RUNNER_GOOGLE_BATCH_SUBNETWORK=${PL_RUNNER_GOOGLE_BATCH_SUBNETWORK:-}"
      - "PL_RUNNER_GOOGLE_BATCH_PROVISIONING=${PL_RUNNER_GOOGLE_BATCH_PROVISIONING:-STANDARD}"
      # - "PL_RUNNER_GOOGLE_BATCH_SERVICE_ACCOUNT=${PL_RUNNER_GOOGLE_BATCH_SERVICE_ACCOUNT:-}"
      # - "PL_RUNNER_EMERGENCY_BOOTSTRAP_FILE=${PL_RUNNER_EMERGENCY_BOOTSTRAP_FILE:-}"
      - "PL_RUNNER_EMERGENCY_BOOTSTRAP_SKIP_AUTO_DETECT=${PL_RUNNER_EMERGENCY_BOOTSTRAP_SKIP_AUTO_DETECT:-false}"

      # Workflow configuration
      - "PL_WORKFLOW_MAX_CONCURRENCY=${PL_WORKFLOW_MAX_CONCURRENCY:-1}"
      - "PL_WORKFLOW_COMPILATION_CACHE_SIZE=${PL_WORKFLOW_COMPILATION_CACHE_SIZE:-2000}"

      # Special options
      - "PL_USE_RESTRICTED_NETWORK_MODE=${PL_USE_RESTRICTED_NETWORK_MODE:-false}"
      - "PL_SKIP_EXTENDED_SELF_CHECK=${PL_SKIP_EXTENDED_SELF_CHECK:-false}"

      # Behavior options
      - "PL_KEEP_WORKDIRS=${PL_KEEP_WORKDIRS:-0s}"
      - "PL_KEEP_GOOD_WORKDIRS=${PL_KEEP_GOOD_WORKDIRS:-20m}"
      - "PL_KEEP_FAULTY_WORKDIRS=${PL_KEEP_FAULTY_WORKDIRS:-1h}"
      - "PL_FEAT_TX_STATS=${PL_FEAT_TX_STATS:-false}"
      - "PL_FEAT_EXPENSIVE_ASSERTIONS=${PL_FEAT_EXPENSIVE_ASSERTIONS:-false}"

      # Hidden behavior options
      - "PL_LISTEN_COMPRESSION=${PL_LISTEN_COMPRESSION:-gzip}"
      - "PL_ENABLE_GRPC_REFLECTION=${PL_ENABLE_GRPC_REFLECTION:-false}"
      - "PL_RUNNER_GOOGLE_BATCH_JOB_DEBUG_SCRIPT=${PL_RUNNER_GOOGLE_BATCH_JOB_DEBUG_SCRIPT:-false}"
      # - "PL_RUNNER_GOOGLE_BATCH_JOB_DUMP_CONFIGS=${PL_RUNNER_GOOGLE_BATCH_JOB_DUMP_CONFIGS:-}"

    volumes:
      - ${PL_AUTH_HTPASSWD:-/dev/null}:/etc/platforma/users.htpasswd
      - ${PL_LICENSE_FILE:-/dev/null}:/storage/mi.license
      - ${PL_LOG_DIR:-/dev/null}:/storage/log/
      - ${PL_DATA_DB_ROOT:-storage-db}:/storage/rocksdb
      - ${PL_DATA_PRIMARY_ROOT:-storage-primary}:/storage/controllers/data/primary/
      - ${PL_DATA_LIBRARY_ROOT:-storage-library}:/storage/controllers/data/library/
      - ${PL_DATA_WORKDIR_ROOT:-storage-workdir}:/storage/controllers/data/work/
      - ${PL_DATA_PACKAGE_ROOT:-storage-package}:/storage/controllers/packageLoader/

    restart: always

volumes:
  storage-db:
  storage-primary:
  storage-library:
  storage-workdir:
  storage-package:
