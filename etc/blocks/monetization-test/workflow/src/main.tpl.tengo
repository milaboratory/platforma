/** Runs a hello world with a turned on monetization, and returns a jwt token. */

self := import("@platforma-sdk/workflow-tengo:workflow")
assets := import("@platforma-sdk/workflow-tengo:assets")
smart := import("@platforma-sdk/workflow-tengo:smart")
exec := import("@platforma-sdk/workflow-tengo:exec")
json := import("json")
ll := import("@platforma-sdk/workflow-tengo:ll")
text := import("text")
file := import("@platforma-sdk/workflow-tengo:file")

self.setPreRun(assets.importTemplate(":pre-run"))

runPerFile := func(inputs) {
	tokens := {}
	progresses := {}
	for _, handle in inputs.inputHandles {
		result := file.importFile(handle.handle)
		progresses[handle.fileName] = result.handle

		// TODO: it should be changed to software that prints an env.
		builder := exec.builder().
			cpu(1).ram("50Mi").
			cmd("/usr/bin/env").
			arg("bash").
			arg("-c").
			arg("echo -n $PLATFORMA_MNZ_JWT").
			enableMnz(inputs.productKey).
			saveStdoutContent()

		ll.print("__THE_LOG__ handle: " + json.encode(handle))
		ll.print("__THE_LOG__ result: " + json.encode(result))

		builder.addFile(handle.fileName, result.file, {mnz: {
			arg: "arg_0",
			metrics: handle.options
		}})

		run := builder.run()

		tokens[handle.fileName] = run.getStdoutFileContent()
	}

	return {
		outputs: {
			token: tokens,
			progresses: progresses
		},
		exports: {}
	}
}

runSingle := func(inputs) {
	// TODO: it should be changed to software that prints an env.
	builder := exec.builder().
		cpu(1).ram("50Mi").
		cmd("/usr/bin/env").
		arg("bash").
		arg("-c").
		arg("echo -n $PLATFORMA_MNZ_JWT").
		enableMnz(inputs.productKey).
		saveStdoutContent()

	progresses := {}
	for _, handle in inputs.inputHandles {
		result := file.importFile(handle.handle)
		progresses[handle.fileName] = result.handle

		builder.addFile(handle.fileName, result.file, {mnz: {
			arg: handle.argName,
			metrics: handle.options
		}})
	}

	run := builder.run()

	return {
		outputs: {
			token: {"single_run": run.getStdoutFileContent()},
			progresses: progresses
		},
		exports: {}
	}
}

self.body(func(inputs) {
	if inputs.shouldAddRunPerFile {
		return runPerFile(inputs)
	}

	return runSingle(inputs)
})
